{% extends 'experiments/base.html' %}

{% block header %}
    {% include 'experiments/header_home.html' %}
{% endblock %}

{% block content %}
    {% if messages %}
        <div class="row">
            <div class="col-md-8">
                {% for message in messages %}
                    {% if message.level_tag == 'success' %}
                        <div class="alert alert-success">{{ message }}</div>
                    {% else %}
                        <div class="alert alert-warning">{{ message }}</div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% endif %}
    <section class="container">
        <div id="id_table_title" class="table-title">
            <h2>List of Experiments</h2>
        </div>
        {% if experiments %}
            {% load experiment_extras %}
            {% if user.is_authenticated and user|has_group:'trustees' %}
                {% include 'experiments/list_trustee.html' %}
            {% else %}
                {% include 'experiments/list_default.html' %}
            {% endif %}
        {% else %}
            <p>There's no experiments yet.</p>
        {% endif %}
    </section>
{% endblock %}

{% block script %}
    {##}
    {## Script related to experiments/list_trustee.html ##}
    {##}
    <script>
    /**
     * Receives experiment status and statuses in json encoding,
     * and construct html with input radios in a form inside modal.
     */
    function statuses_radio_options(experiment, statuses) {
        if ($.isEmptyObject(statuses)) {
            return `
                <p class="alert">You can\'t change an experiment status that has already been approved or rejected.</p>
            `;
        }
        // Start html form
        let html = `
            <form id="id_status_choices" action="/experiments/${experiment.id}/change_status"
            method="POST">
            {% csrf_token %}
        `;
        // Buid input radios with experiment.status === key checked
        for (let key in statuses) {
            if (statuses.hasOwnProperty(key)) {
                let checked = experiment.status === key ? 'checked' : '';
                html += `
                    <input type="radio" name="status" value=${key} ${checked}>${statuses[key]} <br>
                `;
            }
        }
        // Finish html form
        html += `<div id="justification_area"></div>
                <br>
                <div class=modal-footer>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <input id="id_submit" type="submit" value="Save changes" class="btn btn-primary">
                </div>
            </form>
         `;
        return html;

    }
    $('#status_modal').on('show.bs.modal', function (event) {
        let link = $(event.relatedTarget);
        let experiment = {
            id: link.data('experiment_id'),
            title: link.data('experiment_title'),
            status: link.data('experiment_status')
        };
        let statuses = link.data('experiment_statuses');
        let modal = $(this);
        modal.find('.modal-title').text('Change status for experiment ' +
            '"' + experiment.title + '"');
        let modal_body = modal.find('.modal-body');
        let html = statuses_radio_options(experiment, statuses);
        modal_body.text('Please select an option:');
        modal_body.append(html);
        {# if trustee will reprove experiment, force her to write justification #}
        {# message #}
        let modal_form = $('#id_status_choices');
        modal_form.find('input').on('change', function() {
            if ( $('input[name=status]:checked', '#id_status_choices').val()
                === 'not_approved') { // TODO: should be something like Experiment.NOT_APPROVED. See statuses variable.
                $('#justification_area').append(
                    `<br>
                    <span class="alert">Justification is required to
                    reject an experiment (this message will be sent to
                    experiment researcher)*</span>
                    <textarea rows="10" cols="50" id="not_approved_box"
                    name="justification" placeholder="Please write a justification for rejecting this experiment"></textarea>`
                    );
            } else {
                $('#justification_area').empty();
            }
        });
        {# TODO: Prevent submit changing status if user choose NOT_APPROVED and #}
        {# doesn't fill in the justification message #}
{#        modal_form.submit(function (e) {#}
{#            if (#}
{#                $('input[name=status]:checked', '#id_status_choices').val()#}
{#                === 'not_approved' && $('#justification_area').is(':empty')#}
{#            ) {#}
{#                e.preventDefault();#}
{#            }#}
{#        });#}
    });
    </script>

    {##}
    {## Script related to experiments/top.html #}
    {##}
    {% load static %}
    <script src="{% static 'js/new_experiments_received.js' %}"></script>
{% endblock %}
