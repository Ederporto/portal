{% extends 'experiments/base.html' %}

{% block header %}
    {% include 'experiments/header_home.html' %}
{% endblock %}

{% block content %}
    <section class="container">
        <div id="id_table_title" class="table-title">
            <h2>List of Experiments</h2>
        </div>
        {% if experiments %}
            {% load experiment_extras %}
            {% if user.is_authenticated and user|has_group:'trustees' %}
                {% include 'experiments/list_trustee.html' %}
            {% else %}
                {% include 'experiments/list_default.html' %}
            {% endif %}
        {% else %}
            <p>There's no experiments yet.</p>
        {% endif %}
    </section>
{% endblock %}

{% block script %}
    <script> {# this script is related to experiment/list_trustee.html #}
    /**
     * Receives experiment status and statuses in json encoding,
     * and construct html with input radios in a form.
     */
    function statuses_radio_options(experiment, statuses) {
        if ($.isEmptyObject(statuses)) {
            return `
                <p class="alert">You can\'t change an experiment status that has already been approved or rejected.</p>
            `;
        }
        // Start html form
        var html = `
            <form action="/experiments/${experiment.id}/change_status" id="id_status_choices" method="POST">
            {% csrf_token %}
        `;
        // Buid input radios with experiment.status === key checked
        for (var key in statuses) {
            if (statuses.hasOwnProperty(key)) {
                var checked = experiment.status === key ? 'checked' : '';
                html += `
                    <input type="radio" name="status" value=${key} ${checked}>${statuses[key]} <br>
                `;
            }
        }
        // Finish html form
        html += `
                <br>
                <div class=modal-footer>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <input id="id_submit" type="submit" value="Save changes" class="btn btn-primary">
                </div>
            </form>
         `;
        return html;

    }
    $('#status_modal').on('show.bs.modal', function (event) {
            var link = $(event.relatedTarget);
            var experiment = {
                id: link.data('experiment_id'),
                title: link.data('experiment_title'),
                status: link.data('experiment_status')
            };
            var statuses = link.data('experiment_statuses');
            var modal = $(this);
            modal.find('.modal-title').text('Change status for experiment ' +
                '"' + experiment.title + '"');
            var modal_body = modal.find('.modal-body');
            var html = statuses_radio_options(experiment, statuses);
            modal_body.text('Please select an option:');
            modal_body.append(html);
        })
    </script>
{% endblock %}
