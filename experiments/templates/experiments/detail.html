{% extends 'experiments/base.html' %}

{% block header %}
    {% load i18n %}
    {% include 'experiments/header_detail.html' %}
{% endblock %}

{% block content %}
    <section class="container nep-content">
        {% if messages %}
            {% include 'experiments/messages.html' %}
        {% endif %}
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#statistics_tab" role="tab" data-toggle="tab">
                {% trans "Statistics" %}</a></li>
            <li role="presentation"><a href="#groups_tab" role="tab" data-toggle="tab">{% trans "Groups" %}</a></li>
            <li role="presentation"><a href="#settings_tab" role="tab" data-toggle="tab">{% trans "Settings" %}</a></li>
            <li role="presentation"><a href="#questionnaires_tab" role="tab" data-toggle="tab"> {% trans "Questionnaires" %}</a></li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content portal-tab-content">
            <!-- Statistics tab -->
            <div role="tabpanel" class="tab-pane active" id="statistics_tab">
                <div class="row">
                    <div class="col-md-6">
                        <div id="gender-chart" style="height: 300px;"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="age-chart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            <!-- Groups tab -->
            <div role="tabpanel" class="tab-pane groups-tab" id="groups_tab">
                <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                    {% for group in experiment.groups.all %}
                        <div class="panel panel-default nep-panel-group">
                            <div class="row">
                                <div class="col-md-2 prot-exp-image">
                                    {% if group.experimental_protocol.image %}
                                        <a id="protocol_image" href="#"
                                           data-toggle="modal"
                                           data-target="#protocol_image_full"
                                           data-image_path="/media/{{ group.experimental_protocol.image }}">
                                            <img src="/media/{{ group.experimental_protocol.image }}"/></a>
                                    {% endif %}
                                </div>
                                <div class="col-md-10">
                                    <strong>{{ group.title }}</strong>
                                    <br>
                                    {{ group.participants.all.count }}
                                    {% trans "participants" %}
                                    <br><br>
                                    <p>{{ group.description }}</p>
                                    {% if group.inclusion_criteria.all %}
                                        {% trans "Inclusion criterias" %}:
                                        <br>
                                        {% for criteria in group.inclusion_criteria.all %}
                                            {{ criteria.code }} - {{ criteria.description }}{% if not forloop.last %},{% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="pull-right">
                                <a role="button" data-toggle="collapse"
                                   data-parent="#accordion"
                                   href="#collapse{{ group.id }}"
                                   aria-expanded="true"
                                   aria-controls="collapse{{ group.id }}" class="nep-btn">{% trans "Details" %}</a>
                            </div>
                            <br>
                            <div id="collapse{{ group.id }}" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="heading{{ group.id }}">
                                <div class="panel-body">
                                    <strong>{% trans "Textual description" %}</strong>
                                    <pre class="textual-protocol">{{ group.experimental_protocol.textual_description }}</pre>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div role="tabpanel" class="tab-pane" id="settings_tab">
                {% if experiment.eegsetting_set.all %}
                    <strong>{% trans "EEG Settings" %}</strong>
                    {% for eeg_setting in experiment.eegsetting_set.all %}
                        <div class="panel panel-default nep-panel-group">
                            <strong>{{ eeg_setting.name }}</strong><br/>
                            {{ eeg_setting.description }}
                            <div class="pull-right">
                                <a role="button" data-toggle="collapse" data-parent="#accordion"
                                   href="#collapse_eeg_setting_{{ eeg_setting.id }}" aria-expanded="true" class="nep-btn">
                                    {% trans "Details" %}</a>
                            </div>
                            <div id="collapse_eeg_setting_{{ eeg_setting.id }}"
                                 class="panel-collapse collapse out" role="tabpanel" aria-labelledby="heading_eeg_setting_{{ eeg_setting.id }}">
                                {% if eeg_setting.eeg_amplifier_setting %}
                                    <blockquote>
                                        <h5><p>

                                            <strong>{% trans "Amplifier: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.identification }}</strong><br/>
                                            {{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.description }}<br/>
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.serial_number %}
                                                {% trans "serial number: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.serial_number }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.gain %}
                                                {% trans "gain: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.gain }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.number_of_channels %}
                                                {% trans "number of channels: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.number_of_channels }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.common_mode_rejection_ratio %}
                                                {% trans "common mode rejection ratio: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.common_mode_rejection_ratio }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.input_impedance %}
                                                {% trans "input_impedance: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.input_impedance }} {{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.input_impedance_unit }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.amplifier_detection_type_name %}
                                                {% trans "amplifier detection type: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.amplifier_detection_type_name }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.eeg_amplifier.tethering_system_name %}
                                                {% trans "tethering system: " %}{{ eeg_setting.eeg_amplifier_setting.eeg_amplifier.tethering_system_name }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.gain %}
                                                {% trans "gain setting: " %}{{ eeg_setting.eeg_amplifier_setting.gain }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.sampling_rate %}
                                                {% trans "sampling rate: " %}{{ eeg_setting.eeg_amplifier_setting.sampling_rate }}<br/>
                                            {% endif %}
                                            {% if eeg_setting.eeg_amplifier_setting.number_of_channels_used %}
                                                {% trans "number of used channels: " %}{{ eeg_setting.eeg_amplifier_setting.number_of_channels_used }}<br/>
                                            {% endif %}

                                        </p></h5>
                                    </blockquote>

                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if experiment.emgsetting_set.all %}
                    <strong>{% trans "EMG Settings" %}</strong>
                    {% for emg_setting in experiment.emgsetting_set.all %}
                        <div class="panel panel-default nep-panel-group">
                            <strong>{{ emg_setting.name }}</strong><br/>
                            {{ emg_setting.description }}
                            <div class="pull-right">
                                <a role="button" data-toggle="collapse" data-parent="#accordion"
                                   href="#collapse_emg_setting_{{ emg_setting.id }}"
                                   aria-expanded="true" aria-controls="collapse_emg_setting_{{ emg_setting.id }}" class="nep-btn">
                                    {% trans "Details" %}</a>
                            </div>
                            <div id="collapse_emg_setting_{{ emg_setting.id }}"
                                 class="panel-collapse collapse out" role="tabpanel" aria-labelledby="heading_emg_setting_{{ emg_setting.id }}">
                                {% if emg_setting.emg_digital_filter_setting %}
                                    <blockquote>
                                        <h5><p>

                                            <strong>{% trans "Digital filter setting: " %}</strong><br/>
                                            {% trans "filter type name: " %}{{ emg_setting.emg_digital_filter_setting.filter_type_name }}<br/>
                                            {% if emg_setting.emg_digital_filter_setting.filter_type_description %}
                                                {% trans "filter type description: " %}{{ emg_setting.emg_digital_filter_setting.filter_type_description }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.low_pass %}
                                                {% trans "low pass: " %}{{ emg_setting.emg_digital_filter_setting.low_pass }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.high_pass %}
                                                {% trans "high pass: " %}{{ emg_setting.emg_digital_filter_setting.high_pass }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.low_band_pass %}
                                                {% trans "low_band_pass: " %}{{ emg_setting.emg_digital_filter_setting.low_band_pass }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.high_band_pass %}
                                                {% trans "high_band_pass: " %}{{ emg_setting.emg_digital_filter_setting.high_band_pass }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.low_notch %}
                                                {% trans "low_notch: " %}{{ emg_setting.emg_digital_filter_setting.low_notch }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.high_notch %}
                                                {% trans "high_notch: " %}{{ emg_setting.emg_digital_filter_setting.high_notch }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_digital_filter_setting.order %}
                                                {% trans "order: " %}{{ emg_setting.emg_digital_filter_setting.order }}<br/>
                                            {% endif %}

                                        </p></h5>
                                    </blockquote>

                                {% endif %}
                                {% if emg_setting.emg_ad_converter_setting %}
                                    <blockquote>
                                        <h5><p>

                                            <strong>{% trans "A/D converter setting: " %}{{ emg_setting.emg_ad_converter_setting.ad_converter.identification }}</strong><br/>
                                            {{ emg_setting.emg_ad_converter_setting.ad_converter.description }}<br/>
                                            {% if emg_setting.emg_ad_converter_setting.ad_converter.serial_number %}
                                                {% trans "serial number: " %}{{ emg_setting.emg_ad_converter_setting.ad_converter.serial_number }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_ad_converter_setting.ad_converter.signal_to_noise_rate %}
                                                {% trans "signal to noise rate: " %}{{ emg_setting.emg_ad_converter_setting.ad_converter.signal_to_noise_rate }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_ad_converter_setting.ad_converter.resolution %}
                                                {% trans "resolution: " %}{{ emg_setting.emg_ad_converter_setting.ad_converter.resolution }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_ad_converter_setting.ad_converter.sampling_rate %}
                                                {% trans "sampling rate: " %}{{ emg_setting.emg_ad_converter_setting.ad_converter.sampling_rate }}<br/>
                                            {% endif %}
                                            {% if emg_setting.emg_ad_converter_setting.sampling_rate %}
                                                {% trans "sampling rate setting: " %}{{ emg_setting.emg_ad_converter_setting.sampling_rate }}<br/>
                                            {% endif %}

                                        </p></h5>
                                    </blockquote>

                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if experiment.tmssetting_set.all %}
                    <strong>{% trans "TMS Settings" %}</strong>
                    {% for tms_setting in experiment.tmssetting_set.all %}
                        <div class="panel panel-default nep-panel-group">
                            <strong>{{ tms_setting.name }}</strong><br/>
                            {{ tms_setting.description }}
                            <div class="pull-right">
                                <a role="button" data-toggle="collapse" data-parent="#accordion"
                                   href="#collapse_tms_setting_{{ tms_setting.id }}"
                                   aria-expanded="true" aria-controls="collapse_tms_setting_{{ tms_setting.id }}" class="nep-btn">
                                    {% trans "Details" %}</a>
                            </div>
                            <div id="collapse_tms_setting_{{ tms_setting.id }}"
                                 class="panel-collapse collapse out" role="tabpanel" aria-labelledby="heading_tms_setting_{{ tms_setting.id }}">
                                {% if tms_setting.tms_device_setting %}
                                    <blockquote>
                                        <h5><p>

                                            {% if tms_setting.tms_device_setting.pulse_stimulus_type %}
                                                {% trans "pulse stimulus type: " %}{{ tms_setting.tms_device_setting.pulse_stimulus_type }}<br/>
                                            {% endif %}

                                            <br/>

                                            <strong>{% trans "TMS Device: " %}{{ tms_setting.tms_device_setting.tms_device.identification }}</strong><br/>
                                            {% trans "description: " %}{{ tms_setting.tms_device_setting.tms_device.description }}<br/>
                                            {% if tms_setting.tms_device_setting.tms_device.serial_number %}
                                                {% trans "serial number: " %}{{ tms_setting.tms_device_setting.tms_device.serial_number }}<br/>
                                            {% endif %}
                                            {% if tms_setting.tms_device_setting.tms_device.pulse_type %}
                                                {% trans "pulse type: " %}{{ tms_setting.tms_device_setting.tms_device.pulse_type }}<br/>
                                            {% endif %}

                                            <br/>

                                            <strong>{% trans "Coil model: " %}{{ tms_setting.tms_device_setting.coil_model.name }}</strong><br/>
                                            {% if tms_setting.tms_device_setting.coil_model.description %}
                                                {% trans "description: " %}{{ tms_setting.tms_device_setting.coil_model.description }}<br/>
                                            {% endif %}
                                            {% if tms_setting.tms_device_setting.coil_model.coil_shape_name %}
                                                {% trans "coil shape: " %}{{ tms_setting.tms_device_setting.coil_model.coil_shape_name }}<br/>
                                            {% endif %}
                                            {% if tms_setting.tms_device_setting.coil_model.material_name %}
                                                {% trans "material: " %}{{ tms_setting.tms_device_setting.coil_model.material_name }}<br/>
                                            {% endif %}
                                            {% if tms_setting.tms_device_setting.coil_model.material_description %}
                                                {% trans "material description: " %}{{ tms_setting.tms_device_setting.coil_model.material_description }}<br/>
                                            {% endif %}
                                            {% if tms_setting.tms_device_setting.coil_model.coil_design %}
                                                {% trans "coil design: " %}{{ tms_setting.tms_device_setting.coil_model.coil_design }}<br/>
                                            {% endif %}

                                        </p></h5>
                                    </blockquote>

                                {% endif %}
                            </div>

                        </div>
                    {% endfor %}
                {% endif %}
                {% if experiment.contexttree_set.all %}
                    <strong>{% trans "Context trees" %}</strong>
                    {% for context_tree in experiment.contexttree_set.all %}
                        <div class="panel panel-default nep-panel-group">
                            <strong>{{ context_tree.name }}</strong><br/>
                            {{ context_tree.description }}
                            <div class="pull-right">
                                <a role="button" data-toggle="collapse" data-parent="#accordion"
                                   href="#collapse_context_tree_{{ context_tree.id }}"
                                   aria-expanded="true" aria-controls="collapse_context_tree_{{ context_tree.id }}" class="nep-btn">
                                    {% trans "Details" %}</a>
                            </div>
                            <div id="collapse_context_tree_{{ context_tree.id }}"
                                 class="panel-collapse collapse out" role="tabpanel" aria-labelledby="heading_context_tree_{{ context_tree.id }}">
                                {% if context_tree.setting_text %}
                                    <strong>{% trans "setting text: " %}</strong>
                                    <pre class="textual-protocol">{{ context_tree.setting_text }}</pre>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <!-- Questionnaires tab -->
            <div role="tabpanel" class="tab-pane" id="questionnaires_tab">
                {% for group_key, group_values in questionnaire.items %}
                    <h3>Questionnaires for group {{ group_key }}</h3>
                    {% for q_key, q_values in group_values.items %}
                        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                            <div class="panel panel-default">
                                <div class="panel-heading" role="tab"
                                     id="heading{{ q_key }}">
                                    <h4 class="panel-title">
                                        <a href="#collapse{{ q_key }}"
                                           role="button"
                                           data-toggle="collapse"
                                           data-parent="#accordion"
                                           aria-expanded="true"
                                           aria-controls="collapse{{ q_key }}">
                                            Questionnaire {{ q_values.survey_name }}
                                        </a>
                                    </h4>
                                </div>
                                <div class="panel-collapse collapse in"
                                     id="collapse{{ q_key }}"
                                     role="tabpanel"
                                     aria-labelledby="heading{{ q_key }}">
                                    <section id="questionnaire_title">
                                        {% for data in q_values.survey_metadata.data %}
                                            <ul>
                                                <li>{{ data.question_description }}</li>
                                                {% if data.question_limesurvey_type == 'F' %}
                                                    {% include 'experiments/questionnaire/f_type.html' %}
                                                {% elif data.question_limesurvey_type == 'L' %}
                                                    {% include 'experiments/questionnaire/l_type.html' %}
                                                {% elif data.question_limesurvey_type == 'M' or data.question_limesurvey_type == 'B' or data.question_limesurvey_type == 'P' %}
                                                    {% include 'experiments/questionnaire/m_type.html' %}
                                                {% elif data.question_limesurvey_type == 'D' %}
                                                    <p>
                                                        <em>{% trans "The user enters a date in a date field" %}.</em>
                                                    </p>
                                                {% elif data.question_limesurvey_type == '|' %}
                                                    <p>
                                                        <em>{% trans "The user uploads file(s)" %}.</em>
                                                    </p>
                                                {% elif data.question_limesurvey_type == 'Y'%}
                                                    <p>
                                                        <em>{% trans 'The user answers' %}</em> yes <em>or</em> not
                                                    </p>
                                                {% else %}
                                                    <p>
                                                        <em>{% trans "The user enters a free text" %}</em>
                                                    </p>
                                                {% endif %}
                                            </ul>
                                        {% endfor %}
                                    </section>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
        {# Full protocol experiment image modal #}
        <div id="protocol_image_full" class="modal fade" tabindex="-1"
             role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">{% trans "Graphical representation" %}</h4>
                    </div>
                    <div class="modal-body">
                        {# see script bellow #}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </section>
{% endblock %}

{% block script %}
    {##}
    {# Scripts related to experiments/header_detail.html #}
    {##}
    {% load static %}
    <script src="{% static 'js/jquery-ui.min.js' %}"></script>
    <script src="{% static 'js/jquery.fileDownload.js' %}"></script>
    <script src="{% static 'js/download.js' %}"></script>

    {##}
    {# Script related to experiments/top.html #}
    {##}
    <script>
        let to_be_analysed_count = {{ to_be_analysed_count }}
        if (to_be_analysed_count) {
            $('head').append('<style>.badger::after{content:"' +
                to_be_analysed_count + '"}</style>');
        }
    </script>

    {# Display protocol experiment full image #}
    <script>
        $('#protocol_image_full').on('show.bs.modal', function (event) {
            let link = $(event.relatedTarget);
            let image_path = link.data('image_path');
            let modal = $(this);
            modal.find('.modal-body').empty().append(`<img id='full_image'
            src=${image_path} />`); // first empty to not repeat image
        });
    </script>

    {##}
    {# Charts in Statistics tab #}
    {##}
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {packages: ['corechart', 'bar']});
        google.charts.setOnLoadCallback(drawPieChart);
        google.charts.setOnLoadCallback(drawColumnChart);

        function drawPieChart() {
            var data_array = [['Gender', 'Number of participants']];
            var django_data = {{ gender_grouping|safe }};
            for (var item in django_data){
                data_array.push([item, django_data[item]])
            }
            var data = google.visualization.arrayToDataTable(data_array);
            var options = {
                title: 'Gender of the participants',
                pieHole: 0.3
            };
            var chart = new google.visualization.PieChart(document.getElementById('gender-chart'));
            chart.draw(data, options);
        }
        function drawColumnChart() {
            var data_array = [['Age', 'amount' ]];
            var django_data = {{ age_grouping|safe }};
            for (var item in django_data){
                data_array.push([item, django_data[item]])
            }
            var data = google.visualization.arrayToDataTable(data_array);
            var options = {
                title: 'Age of the participants',
                legend: { position: 'none' },
                hAxis: {
                    title: 'Age (years)'
                },
                vAxis: {
                    title: 'Amount'
                }
            };
            var chart = new google.visualization.ColumnChart(document.getElementById('age-chart'));
            chart.draw(data, options);
        }
    </script>
{% endblock %}