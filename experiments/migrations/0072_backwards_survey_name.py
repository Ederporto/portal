# -*- coding: utf-8 -*-
# Generated by Django 1.11.3 on 2017-10-19 18:54
from __future__ import unicode_literals

from django.db import migrations


def backwards_data(apps, schema_editor):
    questionnaire_model = apps.get_model("experiments", "Questionnaire")
    questionnaire_language_model = apps.get_model("experiments", "QuestionnaireLanguage")
    questionnaire_default_language_model = apps.get_model("experiments", "QuestionnaireDefaultLanguage")

    for questionnaire in questionnaire_model.objects.all():
        update_from_questionnaire_language = None

        # try to get from default language
        questionnaire_default_language = \
            questionnaire_default_language_model.objects.filter(questionnaire=questionnaire)
        if questionnaire_default_language:
            update_from_questionnaire_language = questionnaire_default_language.first().questionnaire_language
        else:
            questionnaire_languages = questionnaire_language_model.objects.filter(questionnaire=questionnaire)
            if questionnaire_languages:
                # try to get from english language
                if questionnaire_languages.filter(language_code='en'):
                    update_from_questionnaire_language = questionnaire_languages.filter(language_code='en').first()
                else:
                    update_from_questionnaire_language = questionnaire_languages.first()

        if update_from_questionnaire_language:
            questionnaire.survey_name = update_from_questionnaire_language.survey_name
            questionnaire.survey_metadata = update_from_questionnaire_language.survey_metadata
            questionnaire.save()


def load_data(apps, schema_editor):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('experiments', '0071_questionnaire_name_null'),
    ]

    operations = [
        migrations.RunPython(load_data, backwards_data)
    ]
